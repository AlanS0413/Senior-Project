extends layout.pug
mixin getCartInfo(cartItems)
    ul
        each product in cartItems
            li

block content
    body
        header
            h2.text-center
                b Your Cart
            hr
        .container.rounded
                .row
                    .col-12
                        ul
                            each product in cartItems
                                .container#cart.justify-content-center.rounded
                                    .row.lg-3
                                        .col-lg-4
                                            img(src=`https://seniorprojectcmps450.s3.amazonaws.com/images/${product.sku}`, style="max-width: 80%; height: 80%;")
                                        .col-lg-4
                                            p
                                                b=`${product.brand}`
                                            p
                                                b=`${product.product} - $${product.price}`
                                            p
                                                b=`${product.size}`
                                            p
                                                form.form(action='/cart', method='GET')
                                                    label#cartQuantity.text-black.text-start
                                                    b Quantity:
                                                        select.cartQuantity(name="quantity", onchange='updateTotal()', data-sku=`${product.sku}`)
                                                            - for (var i = 1; i <= Math.min(product.stock, 20); i++)
                                                                option(value=i, selected=i==product.quantity)= i
                                        .col-lg-4.d-flex.justify-content-end
                                            p.text-end
                                                form(action=`/cart/${product.sku}/${product.size}`, method="POST")
                                                    button.btn.btn-danger(id="removerCartItem", type="submit")= 'Remove'
                                        .col-lg-4
                                        br
                                        hr
                        form(action='/checkout', method="POST")
                            .col-lg-12.col-md-10.col-sm-8.col-xs-12
                                p.text-end
                                    b Total: 
                                        span(id="totalPrice") $0.00
                                #paypal-button-container
                            .col-lg-3


                                    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js", integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM", crossorigin="anonymous")
                                    script(src="https://www.paypal.com/sdk/js?client-id=Af2AfpaS9hVvqkAmIYFgjes8XN00wOtPtfFvO1KVhkPdRIWyeRkEEPRXpkikeItaowW63b4OwBX5x1Bz&components=buttons")
                                    script.
                                        jQuery(document).ready(function() {
                                                jQuery('img.center-img.thumbnails').nailthumb({width:335,height:185, method:'resize'});
                                        });
                                        paypal.Buttons({
                                            createOrder: function(data, actions) {
                                                var totalPrice = document.getElementById('totalPrice').textContent.replace('$', '');
                                                totalPrice = parseFloat(totalPrice).toFixed(2); 

                                                return actions.order.create({
                                                    purchase_units: [{
                                                        amount: {
                                                            value: totalPrice
                                                        }
                                                    }]
                                                });
                                            },
                                            onApprove: function(data, actions) {
                                                return actions.order.capture().then(function(details) {
                                                    alert('Transaction completed by ' + details.payer.name.given_name);

                                                    // Now, we will make a call to the server to record this transaction
                                                    fetch('/data', {
                                                        method: 'POST', 
                                                        headers: {
                                                            'Content-Type': 'application/json',
                                                        },
                                                        body: JSON.stringify({
                                                            transactionData: details,

                                                        }),
                                                    })
                                                    .then(function(response) {
                                                        return response.json();
                                                    })
                                                    .then(function(data) {
                                                        console.log('Success:', data);
                                                        
                                                    })
                                                    .catch((error) => {
                                                        console.error('Error:', error);
                                                    });
                                                });
                                            }
                                        }).render('#paypal-button-container');
                                        updateTotal();
